import { kebabcaseToCamelcase } from '@lwrjs/shared-utils';
import { LWC_SSR_PREFIX } from '../identity.js';
import { ssrElement } from './ssr-element.js';
export default function lwcSsrViewTranformer(options, lwrGlobalContext) {
    const { moduleBundler } = lwrGlobalContext;
    return {
        name: 'ssr-lwc-transformer',
        async link(stringBuilder, viewContext, viewMeta) {
            if (viewContext.view.bootstrap?.experimentalSSR) {
                const { customElements } = viewMeta;
                for (const customElementRef of customElements) {
                    if (customElementRef.location) {
                        const { startOffset, endOffset } = customElementRef.location;
                        const moduleSpecifier = kebabcaseToCamelcase(customElementRef.tagName);
                        const ssrSpecifier = `${LWC_SSR_PREFIX}${moduleSpecifier}`;
                        // TODO: Paralelize this await
                        // eslint-disable-next-line no-await-in-loop
                        const ssrResult = await ssrElement({ specifier: ssrSpecifier }, moduleBundler, viewContext.runtimeEnvironment);
                        stringBuilder.overwrite(startOffset, endOffset, ssrResult);
                    }
                }
            }
        },
    };
}
//# sourceMappingURL=index.js.map