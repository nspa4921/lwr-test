import { LwrUnresolvableError, descriptions, isNodeError } from '@lwrjs/diagnostics';
import { pathToRegexp } from 'path-to-regexp';
import qs from 'qs';
import createDOMPurify from 'dompurify';
import { JSDOM } from 'jsdom';
const window = new JSDOM('').window;
const DOMPurify = createDOMPurify(window);
/**
 * Create a status object Express can return when there is an error
 *
 * @param name - string name of the problem module/resource
 * @param error - an Error/Diagnostic object; thrown from try/catch
 */
export function createReturnStatus(name, error) {
    let returnStatus = { status: 501, message: '' };
    if (isNodeError(error) && error.code === 'NO_LWC_MODULE_FOUND') {
        returnStatus = { status: 404, message: descriptions.UNRESOLVABLE.LWC_MODULE(name).message };
    }
    else if (error instanceof LwrUnresolvableError &&
        error.diagnostics[0].description.category === 'lwrUnresolvable/invalid') {
        returnStatus = { status: 400, message: error.message };
    }
    else if (error instanceof LwrUnresolvableError) {
        returnStatus = { status: 404, message: error.message };
    }
    else {
        returnStatus = { status: 500, message: descriptions.UNRESOLVABLE.SERVER_ERROR(name).message };
    }
    returnStatus.message = DOMPurify.sanitize(returnStatus.message);
    return returnStatus;
}
// Adapted from https://github.com/expressjs/express/blob/master/lib/router/layer.js
export function getRequestProperties(pattern, req) {
    const { url = '/' } = req;
    const [pathname, search] = url.split('?');
    const keys = [];
    const regexp = pathToRegexp(pattern, keys);
    const matched = regexp.exec(pathname);
    const params = {};
    if (matched) {
        const query = qs.parse(search);
        for (let i = 1; i < matched.length; i++) {
            const key = keys[i - 1];
            const prop = key.name;
            const val = decode_param(matched[i]);
            if (val !== undefined || !Object.hasOwnProperty.call(params, prop)) {
                params[prop] = val;
            }
        }
        return {
            url,
            params,
            query,
        };
    }
    return;
}
/**
 * Check if the target environment is supported by the application
 *
 * @param environmentConfig - environment property from app config
 * @param targetEnvironment - environment value from module uri
 * @returns boolean
 */
export function isSupportedEnvironment(environmentConfig, targetEnvironment) {
    if (!!targetEnvironment &&
        targetEnvironment !== environmentConfig?.default &&
        !environmentConfig?.supported?.includes(targetEnvironment)) {
        return false;
    }
    return true;
}
function decode_param(val) {
    if (typeof val !== 'string' || val.length === 0) {
        return val;
    }
    return decodeURIComponent(val);
}
//# sourceMappingURL=utils.js.map